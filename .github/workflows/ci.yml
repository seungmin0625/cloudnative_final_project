# CI/CD 워크플로 (Continuous Integration / Continuous Deployment)
name: CI/CD Pipeline for Backend

# main 브랜치에 푸시가 발생할 때만 워크플로 실행
on:
  push:
    branches:
      - main
  workflow_dispatch: # 수동 실행 트리거

# 환경 변수 설정
env:
  DOCKER_IMAGE_NAME: cloudnative-backend # Docker Hub에 사용할 이미지 이름
  IMAGE_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }} # 최종 이미지 레포지토리 경로
  K8S_MANIFEST_PATH: k8s/deployment.yaml # ArgoCD가 감시할 K8s 매니페스트 파일 경로

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 1. 코드 체크아웃 (Checkout code)
        uses: actions/checkout@v4
        with:
          # ArgoCD 트리거를 위한 Manifest 파일 커밋을 위해 토큰 권한 필요
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. Java 환경 설정 (Set up JDK 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven' # Maven 캐싱 활성화

      - name: 3. 백엔드 JAR 빌드 (Build with Maven)
        run: mvn -B package --file pom.xml -DskipTests

      - name: 4. 도커 레지스트리 로그인 (Login to Docker Hub)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 5. 이미지 태그 생성 (Generate Image Tag)
        id: image_tag
        run: |
          # Git 커밋의 짧은 SHA를 태그로 사용 (고유성 확보)
          COMMIT_SHA_SHORT=$(echo $GITHUB_SHA | cut -c1-7)
          echo "tag=$COMMIT_SHA_SHORT" >> $GITHUB_OUTPUT

      - name: 6. 도커 이미지 빌드 및 푸시 (Build and Push Docker image)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_REPO }}:${{ steps.image_tag.outputs.tag }}, ${{ env.IMAGE_REPO }}:latest
          # Dockerfile은 프로젝트 루트에 있다고 가정

      - name: 7. K8s Manifest 이미지 태그 업데이트 (Update K8s Manifest for ArgoCD)
        run: |
          # sed를 사용하여 deployment.yaml 파일의 이미지 태그를 변경
          # 이전 이미지 태그를 새 커밋 SHA 태그로 대체
          sed -i "s|${{ env.IMAGE_REPO }}:.*|${{ env.IMAGE_REPO }}:${{ steps.image_tag.outputs.tag }}|g" ${{ env.K8S_MANIFEST_PATH }}

      - name: 8. ArgoCD 트리거를 위한 Manifest 커밋 (Commit K8s Manifest change)
        run: |
          # Git 사용자 정보 설정
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          
          # 변경된 deployment.yaml 파일을 Git에 커밋
          git add ${{ env.K8S_MANIFEST_PATH }}
          git commit -m "chore(ci): update deployment image to ${{ steps.image_tag.outputs.tag }}"
          
          # 변경 사항을 main 브랜치에 푸시 (이 푸시가 ArgoCD의 트리거가 됨)
          git push